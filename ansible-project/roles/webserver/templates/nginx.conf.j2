server {
    # 1. Naslouchání na portu 80 (HTTP)
    listen {{ http_port | default(80) }};
    # Pouzijte IP adresu nebo _ (wildcard) pro zachyceni vsech domen, pokud neni explicitne definovano
    server_name _; 

    # Umozni NGINX logovat i chyby pri proxy (uzitecne pro ladeni 502 Bad Gateway)
    error_log /var/log/nginx/flask_error.log warn;
    access_log /var/log/nginx/flask_access.log combined;

    # 2. Blok pro statické soubory
    # Pokud URL zacina /static (napr. /static/styly.css), obslouzi to NGINX primo
    location /static {
        # Cesta k vasim CSS/JS/obrazkum na serveru.
        alias {{ site_root_dir }}/flask-web/static;
        # Dulezite: zabrani Flasku zbytecne zpracovavat pozadavky na statiku
        expires 30d;
        add_header Cache-Control "public, no-transform";
    }

    # 3. Blok pro dynamickou aplikaci
    # Vsechny ostatni pozadavky (napr. / nebo /kontakt) preposila na Gunicorn
    location / {
        # *** OPRAVA: POUŽITÍ UNIX SOCKETU MÍSTO TCP PORTU ***
        # Toto musí odpovídat cestě nastavené v systemd službě Gunicornu.
        proxy_pass http://unix:/run/gunicorn/gunicorn.sock; 

        # Nastaveni hlavicek pro spravne predani informaci o klientovi
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Dalsi parametry pro proxy
        proxy_redirect off;
        proxy_buffering off;
        proxy_read_timeout 90s; # Povolit delsi dobu cteni
    }
}
